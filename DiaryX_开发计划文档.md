# DiaryX 开发计划文档

## 项目概述

DiaryX 是一款注重隐私的离线优先日记应用，具备 AI 驱动的语音、文本和视觉内容捕获及智能组织功能。

**总预计时间：17-23 周（4.5-6 个月）**

---

## 第一阶段：架构搭建 (1-2 周)

**注意：在运行任何 Flutter 依赖命令之前，请运行 `proxy` 命令进行本地机器设置。**

### 项目结构与架构

- [x] 实现简单的类 MVC 文件夹结构（models、stores、screens、services、utils、widgets、themes、consts）
- [x] 设置 Provider + ChangeNotifier 状态管理
- [x] 设置基础路由配置
- [x] 在 main.dart 中初始化 MultiProvider 设置

### 数据库基础

- [x] 搭建 Drift 数据库和所有必需表结构
- [x] 创建数据库服务单例
- [x] 实现基础 CRUD 操作

---

## 第二阶段：UI 基础框架 (1-2 周)

### 设计系统

- [x] 实现设计系统（颜色、字体、间距）
- [x] 创建主题管理（明暗模式）
- [x] 设置 themes 文件夹结构（app_theme.dart、app_colors.dart、text_styles.dart）
- [x] 在 widgets 文件夹中创建可复用 UI 组件

### 导航与核心 UI

- [x] 实现导航系统和路由
- [x] 创建主应用结构和底部导航
- [x] 设置基础屏幕模板
- [x] 添加加载状态和错误处理 UI

---

## 第三阶段：认证与基础时刻创建 (2-3 周)

### 身份认证

- [x] 实现数字密码认证
- [x] 设置密码安全存储
- [x] 创建密码设置和验证界面
- [x] 添加基础重试限制机制

### 文本时刻系统

- [x] 创建文本输入界面和编辑器
- [x] 实现自动保存功能
- [x] 添加时刻创建和编辑
- [x] 设置基础时刻存储和检索
- [x] 创建简单时刻列表视图

---

## 第四阶段：多媒体支持 (2-3 周)

### 音频录制

- [x] 集成 record 语音录制
- [x] 实现录制 UI 和波形可视化
- [x] 添加音频播放功能
- [x] 设置音频文件存储和管理

### 相机集成

- [x] 实现照片拍摄功能
- [x] 添加视频录制（最长 5 分钟）
- [x] 设置图片/视频压缩
- [x] 创建媒体预览和选择 UI
- [x] 实现相册访问功能

---

## 第五阶段：内容组织 (2 周)

### 时间线和日历视图

- [x] 创建无限滚动时间线界面
- [x] 实现日历月视图/周视图
- [x] 添加内容类型指示器和缩略图
- [x] 创建时刻卡片和预览内容
- [x] 添加下拉刷新功能

---

## 第六阶段：AI 集成 (3-4 周)

### LLM 引擎设置

- [x] 创建抽象 LLM 引擎接口
- [x] 实现清洁的AI引擎架构并适当分离
- [x] 设置 Ollama API 兼容性
- [x] 创建模拟 AI 引擎用于测试
- [x] 添加本地 vs 远程 AI 配置
- [x] 为所有AI操作实现取消令牌支持

### 核心 AI 功能

- [x] 实现带取消支持的语音转文字处理
- [x] 添加流式文本增强和扩展
- [x] 创建带取消的文本摘要功能
- [x] 实现带取消支持的情绪分析
- [x] 添加带取消支持的标签生成
- [x] 设置向量嵌入生成
- [x] 实现对话AI的流式聊天完成

### AI 引擎架构优化

- [x] 重新组织AI引擎文件夹结构（models/、configs/、implementations/）
- [x] 为所有AI相关数据结构创建统一模型目录
- [x] 实现结构化的AIServiceConfig和AIServiceStatus类
- [x] 在所有方法中添加全面的取消令牌支持
- [x] 清理遗留代码和废弃方法
- [x] 将所有代码注释更新为美式英语

### 通用任务队列系统

- [x] 设计并实现通用的、解耦的任务队列系统
- [x] 创建抽象TaskQueue接口，包含内存和数据库实现
- [x] 实现TaskService作为单例，具有处理器注册功能
- [x] 添加任务优先级、重试逻辑和状态跟踪
- [x] 将任务队列完全从AI引擎中分离（移至lib/services/task/）
- [x] 实现基于数据库的持久化任务队列
- [x] 添加全面的任务统计和监控
- [x] 移除遗留的AiProcessingQueue数据表

---

## 第七阶段：聊天系统实现 (2-3 周)

### 数据库扩展

- [ ] 创建聊天会话管理的 Chats 表
- [ ] 创建个人聊天消息的 ChatMessages 表
- [ ] 为新的聊天相关表添加数据库迁移
- [ ] 在数据库服务中实现聊天 CRUD 操作

### 聊天 UI/UX 实现

- [ ] 实现带会话管理的聊天列表界面
- [ ] 创建带消息显示的聊天对话界面
- [ ] 集成 gpt_markdown 包进行 Markdown 渲染
- [ ] 设计带现代样式的玻璃拟态消息气泡
- [ ] 实现支持图片附件的响应式聊天输入框
- [ ] 添加带打字机效果的流式消息显示

### 聊天功能

- [ ] 实现新聊天创建功能
- [ ] 添加聊天会话持久化和加载
- [ ] 从首条消息创建聊天标题
- [ ] 实现支持文本和图片的消息发送
- [ ] 添加支持取消的流式 AI 响应
- [ ] 集成现有的 AIService 聊天接口

### 导航与路由更新

- [ ] 将搜索标签页更新为带星形图标的聊天标签页
- [ ] 将路由从 '/search' 修改为 '/chat'
- [ ] 更新底部导航配置
- [ ] 实现聊天列表和对话界面之间的导航

### 状态管理

- [ ] 创建聊天状态管理的 ChatStore
- [ ] 实现聊天消息实时更新
- [ ] 添加流式消息状态处理
- [ ] 创建聊天会话管理逻辑

### 依赖和包

- [ ] 添加用于 Markdown 渲染的 gpt_markdown 包
- [ ] 添加用于图片附件的 image_picker 包
- [ ] 更新 pubspec.yaml 和所需依赖
- [ ] 配置图片选择的包权限

---

## 第八阶段：分析洞察 (2 周)

### 数据可视化

- [ ] 集成 fl_chart 数据可视化
- [ ] 创建心情趋势图表和热力图
- [ ] 实现写作频率统计
- [ ] 添加内容类型分布图表
- [ ] 创建情感词云

### 个人仪表板

- [ ] 构建分析仪表板界面
- [ ] 实现个人洞察显示
- [ ] 添加周/月总结
- [ ] 创建 LLM 分析界面
- [ ] 设置重复模式检测

---

## 第九阶段：优化完善 (2-3 周)

### 性能优化

- [ ] 优化数据库查询和索引
- [ ] 实现高效图片/视频加载
- [ ] 为时间线添加懒加载
- [ ] 优化 AI 处理性能
- [ ] 实现适当的内存管理

### UI/UX 增强

- [ ] 添加流畅动画和过渡效果
- [ ] 实现玻璃拟态效果
- [ ] 完善微交互
- [ ] 添加触觉反馈
- [ ] 创建加载状态和骨架屏

### 错误处理

- [ ] 实现全面错误处理
- [ ] 添加用户友好的错误消息
- [ ] 创建离线/在线状态管理
- [ ] 添加数据验证和清理
- [ ] 实现崩溃报告

---

## 第十阶段：测试发布 (1-2 周)

### 质量保证

- [ ] 进行全面功能测试
- [ ] 测试边界情况和错误场景
- [ ] 执行性能和内存测试
- [ ] 在不同设备尺寸和操作系统版本上测试
- [ ] 验证 AI 处理准确性

### 发布准备

- [ ] 设置发布版本构建配置
- [ ] 创建应用图标和启动画面
- [ ] 准备应用商店元数据和截图
- [ ] 编写用户文档和帮助内容
- [ ] 创建引导教程界面

### 最终完善

- [ ] 修复任何剩余 bug 和问题
- [ ] 优化应用大小和启动时间
- [ ] 验证隐私和安全措施
- [ ] 准备应用商店提交
- [ ] 创建备份和数据导出功能

---

## 关键里程碑

- **第 2 周**：架构搭建和数据库基础完成
- **第 4 周**：UI 基础框架和认证就绪
- **第 7 周**：文本时刻和多媒体捕获正常工作
- **第 9 周**：内容组织和基础 UI 完成
- **第 13 周**：AI 功能集成并正常运行，包含优化架构和通用任务队列
- **第 16 周**：聊天系统实现，具备现代 UI/UX 和流式功能
- **第 18 周**：分析洞察功能实现
- **第 21 周**：应用完善并准备测试
- **第 23 周**：发布到应用商店

## 技术依赖

- Flutter 3.32.8 with Dart SDK
- Drift 本地数据库，包含优化的任务队列架构和聊天表
- Gemma 3n 本地 AI 处理，支持取消功能
- 通用任务队列系统用于后台处理
- gpt_markdown 包用于高级 Markdown 渲染
- image_picker 用于聊天图片附件
- 标准 Flutter 包：相机、音频、图表

## 成功标准

- [ ] 完全离线功能
- [ ] 流畅 60fps 性能
- [ ] AI 处理时间少于 30 秒
- [ ] 直观的用户体验
- [ ] 稳定无崩溃运行
